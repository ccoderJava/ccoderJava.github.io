(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{465:function(_,e,s){"use strict";s.r(e);var a=s(9),t=Object(a.a)({},(function(){var _=this,e=_.$createElement,s=_._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[s("p",[_._v("[toc]")]),_._v(" "),s("p",[_._v("hello，大家好，我是聪聪。")]),_._v(" "),s("hr"),_._v(" "),s("h3",{attrs:{id:"_1-故事背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-故事背景"}},[_._v("#")]),_._v(" 1.故事背景")]),_._v(" "),s("p",[_._v("今天在auto_test环境中发现新加密数据均无法解密,全部返回密文。")]),_._v(" "),s("p",[_._v("那么就意味着此时加解密插件未生效或者解密数据时出现了异常，直接返回了"),s("code",[_._v("原文")]),_._v(" 。")]),_._v(" "),s("p",[_._v("查看日志发现待解密数据"),s("code",[_._v("dataDec-1hYWHtIqpctKu7DY+TChRjg=")]),_._v(" 在去掉前缀"),s("code",[_._v("dataDec-1")]),_._v(" 后无法进行Base64转换"),s("code",[_._v("Input byte array has wrong 4-byte ending unit")]),_._v("  ,那么有理由相信是因为落库密文是错误的。")]),_._v(" "),s("p",[_._v("然后检查该字段长度")]),_._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[_._v("account_no\tvarchar(32)\tYES\n")])]),_._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[_._v("1")]),s("br")])]),s("p",[_._v("正好存储数据"),s("code",[_._v("dataDec-1hYWHtIqpctKu7DY+TChRjg=")]),_._v(" 长度也是32。然后这个密文格式长度似乎也少了，会不会MySQL进行了截断。")]),_._v(" "),s("p",[_._v("如果截断了，那么此时数据应该都丢失了，所有密文都无法解密了。")]),_._v(" "),s("h3",{attrs:{id:"_2-问题原因"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-问题原因"}},[_._v("#")]),_._v(" 2.问题原因")]),_._v(" "),s("p",[_._v("查询资料，发现数据库有"),s("code",[_._v("sql_mode")]),_._v("参数控制输入SQL数据是否进行校验。")]),_._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[_._v("select @@SESSION.sql_mode;\n\nNO_ENGINE_SUBSTITUTION\n\n########\n\nSELECT @@GLOBAL.sql_mode;\n\nNO_ENGINE_SUBSTITUTION\n")])]),_._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[_._v("1")]),s("br"),s("span",{staticClass:"line-number"},[_._v("2")]),s("br"),s("span",{staticClass:"line-number"},[_._v("3")]),s("br"),s("span",{staticClass:"line-number"},[_._v("4")]),s("br"),s("span",{staticClass:"line-number"},[_._v("5")]),s("br"),s("span",{staticClass:"line-number"},[_._v("6")]),s("br"),s("span",{staticClass:"line-number"},[_._v("7")]),s("br"),s("span",{staticClass:"line-number"},[_._v("8")]),s("br"),s("span",{staticClass:"line-number"},[_._v("9")]),s("br")])]),s("p",[_._v("查看到这个配置时，那么问题就是因为设置了"),s("code",[_._v("sql_mode")]),_._v("属性，是非严格校验，落库数据长度超过该字段长度，自动进行截取。")]),_._v(" "),s("h3",{attrs:{id:"_3-解决方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-解决方法"}},[_._v("#")]),_._v(" 3.解决方法")]),_._v(" "),s("p",[_._v("修改数据库中"),s("code",[_._v("sql_mode")]),_._v("参数为严格模式，需要设置为以下属性")]),_._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[_._v("ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION\n")])]),_._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[_._v("1")]),s("br")])]),s("p",[_._v("设置方法：修改"),s("code",[_._v("session_variables")]),_._v(" 和"),s("code",[_._v("global_variables")]),_._v(" 全局和会话的该属性配置。")]),_._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[_._v("select * from session_variables t where  t.VARIABLE_NAME = 'sql_mode';\nselect * from global_variables t where  t.VARIABLE_NAME = 'sql_mode';\n")])]),_._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[_._v("1")]),s("br"),s("span",{staticClass:"line-number"},[_._v("2")]),s("br")])]),s("p",[_._v("旧的数据已经丢了，新的数据需要扩展表字段长度，重新落库产生。")]),_._v(" "),s("p",[_._v("这个属性一定要修改为严格模式，可以帮助我们校验当字段落库值较长时出现"),s("code",[_._v("data to long")]),_._v(" 异常，避免出现错误数据，造成不可换回损失。")]),_._v(" "),s("h3",{attrs:{id:"_4-sql-mode有什么用呢"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-sql-mode有什么用呢"}},[_._v("#")]),_._v(" 4. sql_mode有什么用呢")]),_._v(" "),s("p",[_._v("sql_mode有常用的一些值，分别如下：")]),_._v(" "),s("ul",[s("li",[s("code",[_._v("ONLY_FULL_GROUP_BY")]),_._v(" ：对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么这个SQL是不合法的，因为列不在GROUP BY从句中。\n"),s("ul",[s("li",[_._v("虽然说写SQL时，select列中一定要是group by的属性或者聚合函数。但是"),s("code",[_._v("写错了")]),_._v(" SQL，但是本地可以执行通过了，到了生产又不行，那么就需要校验一些是否有该项配置。")])])]),_._v(" "),s("li",[s("code",[_._v("STRICT_TRANS_TABLES")]),_._v(" ：在该模式下，如果一个值不能插入到一个事务表中，则中断当前的操作，对非事务表不做限制。\n"),s("ul",[s("li",[_._v("可以理解为该项配置会使MySQL对插入的数据进行严格校验，错误数据不能够插入并且报错。")]),_._v(" "),s("li",[_._v("开发当中可以理解为：数据到达DB层时都应该是"),s("code",[_._v("合法")]),_._v(" 的，数据的校验应该在业务层而不是在DB层面，但是该项配置是我们数据落地的最后一道保障，也是需要开启的。")])])]),_._v(" "),s("li",[s("code",[_._v("ERROR_FOR_DIVISION_BY_ZERO")]),_._v(" ：在INSERT或UPDATE过程中，如果数据被零除，则产生错误而非警告。如果未给出该模式，那么数据被零除时MySQL返回NULL")]),_._v(" "),s("li",[s("code",[_._v("NO_AUTO_CREATE_USER")]),_._v(" ：禁止GRANT创建密码为空的用户")]),_._v(" "),s("li",[s("code",[_._v("NO_ENGINE_SUBSTITUTION")]),_._v(" ：创建表时如果指定一个不支持或者不存在的引擎会报错")]),_._v(" "),s("li",[s("code",[_._v("NO_ZERO_DATE")]),_._v("：不允许年月日同时为零。例如：0000-00-00。")]),_._v(" "),s("li",[s("code",[_._v("TRADITIONAL")]),_._v(" ：当向mysql数据库插入数据时，进行数据的严格校验，错误数据不能插入并报错。用于事物时，会进行事物的回滚。")])]),_._v(" "),s("p",[_._v("还有一些其他的sql_mode配置在下面参考链接中，可以自习查看MySQL中对于该参数的一些使用场景及其配置。")]),_._v(" "),s("h3",{attrs:{id:"_5-参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-参考资料"}},[_._v("#")]),_._v(" 5.参考资料")]),_._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://dev.mysql.com/doc/refman/5.7/en/sql-mode.html",target:"_blank",rel:"noopener noreferrer"}},[_._v("Server SQL Modes https://dev.mysql.com/doc/refman/5.7/en/sql-mode.html"),s("OutboundLink")],1)])]),_._v(" "),s("hr"),_._v(" "),s("p",[_._v("了解更多内容，可以关注我的微信公众号，更多首发文章。\n"),s("img",{attrs:{src:"https://ccoder-markdown-oss.oss-cn-shanghai.aliyuncs.com/md/2022-07-28-064228.bmp",alt:"wechat"}})])])}),[],!1,null,null,null);e.default=t.exports}}]);