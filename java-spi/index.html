<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>利用SPI机制进行插件解耦 | 聪聪碎碎念</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="./favicon.ico">
    <script src="https://www.googletagmanager.com/gtag/js?id=G-40YT5YJMBG" async="true"></script>
    <script> window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-40YT5YJMBG');</script>
    <script>var _hmt = _hmt || [];
               (function() {
                 var hm = document.createElement("script");
                 hm.src = "https://hm.baidu.com/hm.js?921719b1f1d6a98cb84343b54b11c7dd";
                 var s = document.getElementsByTagName("script")[0];
                 s.parentNode.insertBefore(hm, s);
               })();</script>
    <link rel="alternate" type="application/rss+xml" href="http://www.ccoder.cc/rss.xml" title="聪聪碎碎念 RSS Feed">
    <meta name="description" content="[toc]

hello，大家好，我是聪聪。

最近在重构一款底层数据加解密中间件，里面有一些内容需要解耦：

针对不同数据源处理单独，MySQL、MongoDB、ES数据源进行加解密处理。
可插拔扩展不同加解密算法。
兼容不同日志框架做数据脱敏，自定义客制化脱敏规则。

在这里设想通过SPI机制，让接入业务方可进行插件客制化扩展。
中间件内提供业务通用AES加解密方法，同时 ...">
    <meta name="Keywords" content="ccoderJava,ccoder,聪聪的日志">
    
    <link rel="preload" href="/assets/css/0.styles.011b59ea.css" as="style"><link rel="preload" href="/assets/js/app.7b778307.js" as="script"><link rel="preload" href="/assets/js/7.97c4f7f9.js" as="script"><link rel="preload" href="/assets/js/3.42bf2e6b.js" as="script"><link rel="preload" href="/assets/js/21.6460c15b.js" as="script"><link rel="prefetch" href="/assets/js/10.531f4524.js"><link rel="prefetch" href="/assets/js/11.58aec4b6.js"><link rel="prefetch" href="/assets/js/12.24549026.js"><link rel="prefetch" href="/assets/js/13.7ca212e0.js"><link rel="prefetch" href="/assets/js/14.866271cf.js"><link rel="prefetch" href="/assets/js/15.b4f89f2c.js"><link rel="prefetch" href="/assets/js/16.554ad734.js"><link rel="prefetch" href="/assets/js/17.4c4bb8be.js"><link rel="prefetch" href="/assets/js/18.5b4cbac5.js"><link rel="prefetch" href="/assets/js/19.5523123d.js"><link rel="prefetch" href="/assets/js/20.cae0dcf4.js"><link rel="prefetch" href="/assets/js/22.1c7d6f32.js"><link rel="prefetch" href="/assets/js/23.13195399.js"><link rel="prefetch" href="/assets/js/24.41b250c4.js"><link rel="prefetch" href="/assets/js/25.95a8c30c.js"><link rel="prefetch" href="/assets/js/26.1c1ea10b.js"><link rel="prefetch" href="/assets/js/27.e3ff3995.js"><link rel="prefetch" href="/assets/js/28.4932824c.js"><link rel="prefetch" href="/assets/js/29.f7d5698d.js"><link rel="prefetch" href="/assets/js/30.93fd6aba.js"><link rel="prefetch" href="/assets/js/31.81151b77.js"><link rel="prefetch" href="/assets/js/32.6d8a4e2b.js"><link rel="prefetch" href="/assets/js/33.ed83d4b8.js"><link rel="prefetch" href="/assets/js/34.03576be8.js"><link rel="prefetch" href="/assets/js/35.65084bb6.js"><link rel="prefetch" href="/assets/js/36.0759daae.js"><link rel="prefetch" href="/assets/js/37.37caabf6.js"><link rel="prefetch" href="/assets/js/38.515763e2.js"><link rel="prefetch" href="/assets/js/39.04dd744d.js"><link rel="prefetch" href="/assets/js/4.a4c65c8f.js"><link rel="prefetch" href="/assets/js/40.0624546c.js"><link rel="prefetch" href="/assets/js/41.5bea29b8.js"><link rel="prefetch" href="/assets/js/42.2c1415b0.js"><link rel="prefetch" href="/assets/js/43.3d05244b.js"><link rel="prefetch" href="/assets/js/44.f3456612.js"><link rel="prefetch" href="/assets/js/45.772c60b6.js"><link rel="prefetch" href="/assets/js/46.ba97a1d0.js"><link rel="prefetch" href="/assets/js/47.f3ba6614.js"><link rel="prefetch" href="/assets/js/48.db14f4af.js"><link rel="prefetch" href="/assets/js/49.303ece5e.js"><link rel="prefetch" href="/assets/js/5.83f49348.js"><link rel="prefetch" href="/assets/js/50.48f0bbe8.js"><link rel="prefetch" href="/assets/js/51.fc7e32ab.js"><link rel="prefetch" href="/assets/js/52.da0c4e96.js"><link rel="prefetch" href="/assets/js/53.315f2104.js"><link rel="prefetch" href="/assets/js/54.2faba730.js"><link rel="prefetch" href="/assets/js/55.178970d9.js"><link rel="prefetch" href="/assets/js/6.80737f31.js"><link rel="prefetch" href="/assets/js/8.871b00b2.js"><link rel="prefetch" href="/assets/js/9.da852c59.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.a832fb5e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.011b59ea.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">聪聪碎碎念 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">文章</a></li><li class="nav-item"><a href="/notes/" class="nav-link">随笔</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="nav-item"><a href="https://ccoderjava.github.io/chencong_Java Development Engineer_5 years.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">个人简历</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">聪聪碎碎念 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">文章</a></li><li class="mobile-nav-item"><a href="/notes/" class="nav-link">随笔</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="mobile-nav-item"><a href="https://ccoderjava.github.io/chencong_Java Development Engineer_5 years.pdf" target="_blank" rel="noopener noreferrer" class="nav-link external">个人简历</a></li> <li class="mobile-nav-item"><a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        利用SPI机制进行插件解耦
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">聪聪</span> <!----></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2022-08-16T15:07:09.000Z">
      2022-08-16 03:07:09
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/SPI" data-v-42ccfcd5><span data-v-42ccfcd5>SPI</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/Java" data-v-42ccfcd5><span data-v-42ccfcd5>Java</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>[toc]</p> <p>hello，大家好，我是聪聪。</p> <hr> <p>最近在重构一款底层数据加解密中间件，里面有一些内容需要解耦：</p> <ul><li>针对不同数据源处理单独，MySQL、MongoDB、ES数据源进行加解密处理。</li> <li>可插拔扩展不同加解密算法。</li> <li>兼容不同日志框架做数据脱敏，自定义客制化脱敏规则。</li></ul> <p>在这里设想通过SPI机制，让接入业务方可进行插件客制化扩展。
中间件内提供业务通用AES加解密方法，同时提供接口业务方自行扩展其他加解密算法：RSA等。
那么就在这里总结一下SPI机制是什么。</p> <h2 id="_1-介绍"><a href="#_1-介绍" class="header-anchor">#</a> 1.介绍</h2> <blockquote><p>SPI 全称为 Service Provider Interface，是一种服务发现机制。通过在ClassPath路径下的META-INF/services文件夹查找文件，自动加载文件里所定义的类。通常用来实现扩展第三方API，进行插件替换。</p></blockquote> <p>之前介绍过一篇Dubbo中的SPI机制，Dubbo中扩展点机制是对JDK的SPI进行了深度加强，解决了JDK SPI的一些痛点问题：</p> <ul><li>JDK标准SPI机制会一次性将所有实现进行加载(Iterator方式)，无论使用与否。如果实现类初始化过程较耗时，在加载上会很浪费资源。</li> <li>如果扩展点加载失败，也就连扩展点实现类的名称也无法拿到。</li> <li>增加了对扩展点的IoC和AOP的支持，一个扩展点可以直接setter注入其他扩展点。</li></ul> <p>详细内容可以参考<a href="https://blog.ccoder.cc/dubbo-extensionloader/" target="_blank" rel="noopener noreferrer">Dubbo-ExtensionLoader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这篇文章。
<img src="https://ccoder-markdown-oss.oss-cn-shanghai.aliyuncs.com/md/2022-08-16-064829.png" alt="image.png"></p> <h2 id="_2-使用介绍"><a href="#_2-使用介绍" class="header-anchor">#</a> 2.使用介绍</h2> <p>按照上面SPI的思想我们下面实现一个小例子。</p> <h3 id="_2-1-定义一个标准接口"><a href="#_2-1-定义一个标准接口" class="header-anchor">#</a> 2.1 定义一个标准接口</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cc<span class="token punctuation">.</span>ccoder<span class="token punctuation">.</span>cipher</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CipherStrategy</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
    * 加密处理
    *
    * @param plainText 明文
    * @return 加密结束后返回密文,异常时原文本
    */</span>
    <span class="token class-name">String</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
    * 解密处理
    *
    * @param ciphertext 密文
    * @return 解密结束后返回明文,异常时返回原文本
    */</span>
    <span class="token class-name">String</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> ciphertext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_2-2-定义实现类"><a href="#_2-2-定义实现类" class="header-anchor">#</a> 2.2 定义实现类</h3> <p>上面定义的接口可以理解为一个规范，各服务提供方可自行实现。
下面就对上面接口进行实现。
实现内容便是该接口的具体业务逻辑实现，在这里简化处理，直接打印一句话。</p> <ul><li>实现一：AES加解密处理</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cc<span class="token punctuation">.</span>ccoder<span class="token punctuation">.</span>cipher</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AESCipherStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">CipherStrategy</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> plainText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;AES加密处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> plainText<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> ciphertext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;AES解密处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ciphertext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li>实现二：RSA加解密处理</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cc<span class="token punctuation">.</span>ccoder<span class="token punctuation">.</span>cipher</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RSACipherStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">CipherStrategy</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> plainText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;RSA加密处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> plainText<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> ciphertext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;RSA解密处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ciphertext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_2-3-定义配置文件"><a href="#_2-3-定义配置文件" class="header-anchor">#</a> 2.3 定义配置文件</h3> <p>需要在<code>classpath</code>路径下定义一个配置文件。</p> <ul><li>文件名称为：<strong>接口全限定类名</strong></li> <li>文件内容为：<strong>实现类的全限定类名，多个实现类用换行符分割</strong></li></ul> <p><img src="https://ccoder-markdown-oss.oss-cn-shanghai.aliyuncs.com/md/2022-08-16-064927.png" alt="image.png"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>cc<span class="token punctuation">.</span>ccoder<span class="token punctuation">.</span>cipher<span class="token punctuation">.</span><span class="token class-name">RSACipherStrategy</span>
cc<span class="token punctuation">.</span>ccoder<span class="token punctuation">.</span>cipher<span class="token punctuation">.</span><span class="token class-name">AESCipherStrategy</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-4-使用方式"><a href="#_2-4-使用方式" class="header-anchor">#</a> 2.4 使用方式</h3> <p>上面已经使用SPI机制进行扩展实现<code>CipherStrategy</code>接口，并且存在两个扩展点<code>RSACipherStrategy</code>、<code>AESCipherStrategy</code>。
通常情况下标准接口定义为规范，扩展点实现为不同服务提供方实现，从而实现可插拔解耦。
例如：Java提供数据库驱动接口<code>java.sql.Driver</code>，不同数据库提供商对其进行实现。并且我们也能够在该数据库提供商的client 依赖中找到SPI定义的实现类名称。MySQL可以在<code>mysql-connenctor-java</code>依赖中的<code>META-INF/services</code>中找到对<code>java.sql.Driver</code>接口的实现：<code>com.mysql.jdbc.Driver</code>。
看下面代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//java.util中ServiceLoader</span>
    <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CipherStrategy</span><span class="token punctuation">&gt;</span></span> load <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">CipherStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//sun.misc中Service</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CipherStrategy</span><span class="token punctuation">&gt;</span></span> providers <span class="token operator">=</span> <span class="token class-name">Service</span><span class="token punctuation">.</span><span class="token function">providers</span><span class="token punctuation">(</span><span class="token class-name">CipherStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CipherStrategy</span> cipherStrategy <span class="token operator">:</span> load<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cipherStrategy<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>providers<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">CipherStrategy</span> cipherStrategy <span class="token operator">=</span> providers<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipherStrategy<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 以下为输出结果</span>
RSA 加密处理
AES 加密处理
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
RSA 加密处理
AES 加密处理
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>我们可以通过<code>ServiceLoader.load()</code>或<code>Service.providers()</code>方法获取到该标准接口的扩展点类实现。如上注释所示两种方式提供方不一样。</p> <ul><li><code>ServiceLoader.load()</code>为<code>java.util.ServiceLoader</code>提供。</li> <li><code>Service.providers()</code>为<code>sun.misc.Service</code>提供。</li></ul> <p>如上输出结果所示：两种方式执行顺序、执行结果一致。</p> <p>肯定有人会说：这就是策略模式、接口多实现而已，为何还要如此复杂定义配置文件呢？
这里要明确一个场景：
接口定义、接口实现并不在一个服务、一个包中。
假设：开发中间件时，通常定义一个加解密接口、路由转发接口、熔断策略方案等，在中间件中可以提供一种常用、通用的默认实现方式，若业务方或引入方存在特殊场景需要自行实现以上接口时，是不是就不好处理了，必须推送中间件进行提供该能力了。
因此，可以使用SPI机制进行暴露接口，业务方自行实现，从而实现扩展功能，可插拔插件式开发。
顺便说一下Java中默认提供了SPI机制，但是该机制存在一些痛点，介绍部分已经说明。Dubbo中对该SPI机制进行重写为ExtensionLoader方法，能够实现更加强大的插件式开发。</p> <blockquote><p>Dubbo 强大的服务治理能力不仅体现在核心框架上，还包括其优秀的扩展能力以及周边配套设施的支持。通过 Filter、Router、Protocol 等几乎存在于每一个关键流程上的扩展点定义，我们可以丰富 Dubbo 的功能或实现与其他微服务配套系统的对接，包括 Transaction、Tracing 目前都有通过 SPI 扩展的实现方案，具体可以参见 Dubbo 扩展性的详情，也可以在 <a href="https://github.com/apache/dubbo-spi-extensions" target="_blank" rel="noopener noreferrer">apache/dubbo-spi-extensions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 项目中发现与更多的扩展实现。</p> <ul><li><a href="https://dubbo.apache.org/zh/overview/what/ecosystem" target="_blank" rel="noopener noreferrer">Dubbo 生态<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://dubbo.apache.org/zh/overview/what/extensibility" target="_blank" rel="noopener noreferrer">Dubbo 可扩展性设计<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></blockquote> <h2 id="_3-源码分析"><a href="#_3-源码分析" class="header-anchor">#</a> 3.源码分析</h2> <p>言归正传，接下来看看<code>ServiceLoader.load()</code>源码中是如何加载获取到接口的实现类。
我们根据<code>ServiceLoader.load()</code>方法进入源码中捋一捋SPI是如何加载获得到实例的。</p> <h3 id="_3-1-类成员变量梳理"><a href="#_3-1-类成员变量梳理" class="header-anchor">#</a> 3.1 类成员变量梳理</h3> <p>如下源码所示：先梳理<code>ServiceLoader</code>中常用的重要成员变量。
注意：部分源码已删除，可忽略。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>

    <span class="token comment">// 指定加载目录，配置文件目录，classpath目录下，用来查找该目录中的接口扩展点实现。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> PREFIX <span class="token operator">=</span> <span class="token string">&quot;META-INF/services/&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 表示当前正在被加载的类或者接口，例如此处便是我们定义的标准接口:CipherStrategy</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">;</span>

    <span class="token comment">// 类加载器,用来定位、加载、实例化接口实现(实例化下面providers的类加载器)</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">;</span>

    <span class="token comment">// 访问控制上下文,后续通过反射创建接口实现类时候需要使用</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AccessControlContext</span> acc<span class="token punctuation">;</span>

    <span class="token comment">// 已被加载的服务类集合,按照顺序，注意此处是LinedHashMap 链表存在顺序的。</span>
    <span class="token keyword">private</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> providers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 内部类，当前懒加载服务类，也是真正的类加载器。</span>
    <span class="token keyword">private</span> <span class="token class-name">LazyIterator</span> lookupIterator<span class="token punctuation">;</span>

    <span class="token comment">//省略其余逻辑代码...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>这样，我们就有了大致脉络：</p> <ul><li>定义类加载器<code>ClassLoader</code>，用来加载、实例化接口实现类。至于说该类加载器来源是哪里，后续源码有说明。</li> <li>扩展点加载目录，JDK已固定。</li> <li>已被加载的扩展类集合，使用<code>LinkedHashMap</code>存储，按照配置文件顺序。</li> <li>扩展类加载机制，在内部类<code>LazyIterator</code>中实现。</li> <li>实现<code>Iterable</code>接口，为后续迭代所有扩展点实现类时做铺垫。</li></ul> <p><code>ServiceLoader.load()</code>方法中存在两个重载方法：</p> <ul><li><code>ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service)</code> <ul><li>service 为当前扩展点接口类</li> <li>使用的类加载器为当前线程的类加载器。<code>Thread.currentThread().getContextClassLoader()</code>。</li> <li>调用下面加载方法。</li></ul></li> <li><code>ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service, ClassLoader loader)</code> <ul><li>service为当前扩展点接口类</li> <li>使用指定类加载器。</li> <li>内部实例化构造器，在构造器中对上述成员变量进行定义说明。</li> <li>重新加载<code>reload()</code>所有服务类加载集合。</li> <li>调用<code>LazyIterator</code>构造方法，初始化该懒加载。此时并没有真正实例化加载类。</li> <li>调用<code>hasNext()</code>迭代时进行加载扩展点实现类。</li></ul></li></ul> <h3 id="_3-2-查找实现类"><a href="#_3-2-查找实现类" class="header-anchor">#</a> 3.2 查找实现类</h3> <p>查找实现类及创建实现类的过程均在内部类<code>LazyIterator</code>中完成。当我们调用<code>providers.hasNext()</code>或<code>providers.next()</code>时，均是内部类<code>LazyIterator</code>的方法，实现<code>Iterator</code>的方法。
因此我们着重关注一下<code>LazyIterator.next()</code>方法，其中最终会调用到<code>hashNextService()</code>方法，详细细节看下面源码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">LazyIterator</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>
    <span class="token comment">// 一些成员变量，下面根据源码说明成员变量含义。</span>
    <span class="token comment">// 接口类,此处便是定义的标准接口CipherStrategy</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">;</span>
    <span class="token comment">// 类加载器</span>
    <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">;</span>
    <span class="token comment">// 接口全限定类名转化成URL</span>
    <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> configs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 迭代器</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> nextName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">//内部构造行数，在ServiceLoader的构造函数中进行初始化加载</span>
    <span class="token keyword">private</span> <span class="token class-name">LazyIterator</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> service<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loader <span class="token operator">=</span> loader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">hasNextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 迭代时，判断是否存在实现类名称</span>
        <span class="token comment">// 第一次加载时为空 继续执行</span>
        <span class="token comment">// 第二次加载时已经解析完成，直接返回。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// PREFIX : 定义的加载目录 : META-INF/services/</span>
                <span class="token comment">// fullName 加载目录+ 接口类的全限定类名,就可以定位到该接口的配置路径.</span>
                <span class="token comment">// META-INF/services/cc.ccoder.cipher.CipherStrategy</span>
                <span class="token class-name">String</span> fullName <span class="token operator">=</span> PREFIX <span class="token operator">+</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>loader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token comment">//类加载器为空时 ServiceLoader构造器中未指定,才用系统默认类加载器进行加载接口全限定类名</span>
                    configs <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemResources</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    configs <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Error locating configuration files&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//迭代器初始化为空 或者 没有下一个元素时进入循环</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pending <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>pending<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 接口文件中没有多余元素时</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configs<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//解析</span>
            pending <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> configs<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//解析完成</span>
        nextName <span class="token operator">=</span> pending<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>上面逻辑更多的是判断当前接口在配置文件中是否存在实现类定义，如果存在则继续<code>next()</code>方法获取，在<code>next()</code>逻辑中则是使用<code>nextService()</code>方法真正的拿到接口类的实现类。</p> <h3 id="_3-3-实例化接口实现类"><a href="#_3-3-实例化接口实现类" class="header-anchor">#</a> 3.3 实例化接口实现类</h3> <p>下面逻辑就是通过nextName 接口实现类全限定类名拿到该接口实现类的class对象，并且将其实例化的过程。当然也将实例化对象放入定义好的LinkedHashMap集合中。
到此，源码部分便结束了。
拿到了接口实现类的对象实例了，那么接下里的便是业务运用过程，可以为所欲为的使用啦。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">S</span> <span class="token function">nextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//接口文件中不存在实现类记录时 直接抛出NoSuchElementException异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasNextService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//接口全限定类名</span>
    <span class="token class-name">String</span> cn <span class="token operator">=</span> nextName<span class="token punctuation">;</span>
    nextName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//接口实现类class对象</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//接口实现类的class对象</span>
        c <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>cn<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Provider &quot;</span> <span class="token operator">+</span> cn <span class="token operator">+</span> <span class="token string">&quot; not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断实现类和几口的参数类型是否一致 ，否则直接fail返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>service<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Provider &quot;</span> <span class="token operator">+</span> cn  <span class="token operator">+</span> <span class="token string">&quot; not a subtype&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//通过newInstance实例化对象</span>
        <span class="token class-name">S</span> p <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将对象放入放入实现类集合中 并且返回对象.</span>
        providers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cn<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fail</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token string">&quot;Provider &quot;</span> <span class="token operator">+</span> cn <span class="token operator">+</span> <span class="token string">&quot; could not be instantiated&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// This cannot happen</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="_4-应用场景"><a href="#_4-应用场景" class="header-anchor">#</a> 4.应用场景</h2> <p>SPI机制在日常开发中经常会遇到，只是我们关注使用中间件功能，忽略了其本质如何实现扩展、灵活插件可插拔的。</p> <h3 id="_4-1-jdbc使用场景"><a href="#_4-1-jdbc使用场景" class="header-anchor">#</a> 4.1 JDBC使用场景</h3> <p>从上面接口实现类的class对象实例化逻辑可以看到很熟悉的方法：<code>Class.forName()</code>方法。
在我们最开始使用JDBC连接MySQL数据库时，就是先何止数据库连接驱动，再通过DriverManager获得一个数据库连接。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;jdbc:mysql://localhost:3306/test_db&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> user <span class="token operator">=</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">&quot;chencong&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> aClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;com.mysql.jdbc.Driver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> user<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_4-1-1-加载驱动"><a href="#_4-1-1-加载驱动" class="header-anchor">#</a> 4.1.1 加载驱动</h4> <p>我们继续查看<code>DriverManager</code>类是如何加载数据库驱动的。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadInitialDrivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//省略其余逻辑...</span>
    <span class="token class-name">String</span> drivers<span class="token punctuation">;</span>
    <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name">Void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ServerLoader加载SQL 驱动接口 java.sql.Driver</span>
            <span class="token comment">//加载接口java.sql.Driver的实现类：</span>
            <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Driver</span><span class="token punctuation">&gt;</span></span> loadedDrivers <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Driver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Driver</span><span class="token punctuation">&gt;</span></span> driversIterator <span class="token operator">=</span> loadedDrivers<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//逐个加载校验</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                <span class="token keyword">while</span><span class="token punctuation">(</span>driversIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    driversIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Do nothing</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>drivers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> drivers<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> driversList <span class="token operator">=</span> drivers<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> aDriver <span class="token operator">:</span> driversList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//逐个实例化加载</span>
            <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>aDriver<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;DriverManager.Initialize: load failed: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h4 id="_4-1-2-创建driver实例"><a href="#_4-1-2-创建driver实例" class="header-anchor">#</a> 4.1.2 创建Driver实例</h4> <p>上面已经通过<code>java.sql.Driver</code>全限定类名加载到了MySQL的实现类，那么就应该通过next() 方法去初始化实现该类。实现类只完成了：向DriverManager中注册MySQL的Driver实现类。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Driver</span> <span class="token keyword">extends</span> <span class="token class-name">NonRegisteringDriver</span> <span class="token keyword">implements</span> java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span><span class="token class-name">Driver</span> <span class="token punctuation">{</span>
    <span class="token comment">//向DriverManager注册MySQL Driver驱动实现类</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span><span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">registerDriver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> <span class="token class-name">E</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Can't register driver!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token comment">// Required for Class.forName().newInstance()</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_4-1-3-获取connection连接"><a href="#_4-1-3-获取connection连接" class="header-anchor">#</a> 4.1.3 获取Connection连接</h4> <p>在<code>DriverManager.getConnection()</code>方法中获取数据库连接信息。
这里便是循环加载所有已经注册到<code>DriverManager</code>中的Driver实现类，调用连接connect方法获得数据库连接connection，并且返回。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token class-name">Properties</span> info<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> caller<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token comment">//类加载器获取,有则使用，无则获取当前线程类加载器。</span>
    <span class="token class-name">ClassLoader</span> callerCL <span class="token operator">=</span> caller <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> caller<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// synchronize loading of the correct classloader.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callerCL <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            callerCL <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//省略部分判断校验逻辑...</span>

    <span class="token comment">//循环加载registeredDrivers列表中的渠道，该列表来源于实现类向其中注册。</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">DriverInfo</span> aDriver <span class="token operator">:</span> registeredDrivers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断逻辑：判断当前渠道实现类是否可以正确加载得到。</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isDriverAllowed</span><span class="token punctuation">(</span>aDriver<span class="token punctuation">.</span>driver<span class="token punctuation">,</span> callerCL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//获取数据库连接</span>
                <span class="token class-name">Connection</span> con <span class="token operator">=</span> aDriver<span class="token punctuation">.</span>driver<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>con <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Success!</span>
                    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;getConnection returning &quot;</span> <span class="token operator">+</span> aDriver<span class="token punctuation">.</span>driver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span>con<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    reason <span class="token operator">=</span> ex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;    skipping: &quot;</span> <span class="token operator">+</span> aDriver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token comment">//获取数据库连接失败，打印一些异常信息，已省略...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h4 id="_4-1-4-自定义扩展实现类"><a href="#_4-1-4-自定义扩展实现类" class="header-anchor">#</a> 4.1.4 自定义扩展实现类</h4> <p>上面我们知道了JDBC数据库连接创建过程，我们按照SPI的机制自定义一个数据库连接方式，并且可以修改、添加一些信息。理论上可以完成。</p> <ul><li>创建一个自定义Driver类，取名为<code>CustomDriver</code>继承<code>NonRegisteringDriver</code>实现<code>java.sql.Driver</code>接口。</li> <li>在<code>META-INF/services</code>目录下创建一个<code>java.sql.Driver</code>文件，文件内容为我们自定义<code>CustomDriver</code>类的全限定类名。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomDriver</span> <span class="token keyword">extends</span> <span class="token class-name">NonRegisteringDriver</span> <span class="token keyword">implements</span> <span class="token class-name">Driver</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span><span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">registerDriver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> <span class="token class-name">E</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Can't register driver!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Construct a new driver and register it with DriverManager
     *
     * @throws SQLException
     *             if a database error occurs.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">Properties</span> info<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里父类NonRegisteringDriver 中完成数据库连接信息</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;CustomDriver数据库连接url:&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;CustomDriver数据库连接信息:&quot;</span> <span class="token operator">+</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> connect <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;CustomDriver数据库连接加载完成:&quot;</span> <span class="token operator">+</span> connect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> connect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//输出信息如下：</span>
<span class="token class-name">Connected</span> <span class="token keyword">to</span> <span class="token namespace">the</span> target VM<span class="token punctuation">,</span> address<span class="token operator">:</span> <span class="token string">'127.0.0.1:51817'</span><span class="token punctuation">,</span> transport<span class="token operator">:</span> <span class="token string">'socket'</span>
<span class="token class-name">CustomDriver</span>数据库连接url<span class="token operator">:</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>test_db
<span class="token class-name">CustomDriver</span>数据库连接信息<span class="token operator">:</span><span class="token punctuation">{</span>user<span class="token operator">=</span>root<span class="token punctuation">,</span> password<span class="token operator">=</span>chencong<span class="token punctuation">}</span>
<span class="token class-name">CustomDriver</span>数据库连接加载完成<span class="token operator">:</span>com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span><span class="token class-name">ConnectionImpl</span><span class="token annotation punctuation">@48e1f6c7</span>
<span class="token class-name">Disconnected</span> from the target VM<span class="token punctuation">,</span> address<span class="token operator">:</span> <span class="token string">'127.0.0.1:51817'</span><span class="token punctuation">,</span> transport<span class="token operator">:</span> <span class="token string">'socket'</span>

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>从上面输出打印信息可以看到，加载数据库驱动实现类时已经加载到我们自定义<code>CustomDriver</code>类中，因为我们继承了<code>NonRegisteringDriver</code>类，所以数据库连接信息最终还是由该类完成。
同时我们也可以在<code>DriverManager</code>中看到目前<code>java.sql.Driver</code>存在两个实现类。
<img src="https://ccoder-markdown-oss.oss-cn-shanghai.aliyuncs.com/md/2022-08-16-064917.png" alt="image.png"></p> <h3 id="_4-2-validationprovider-数据校验"><a href="#_4-2-validationprovider-数据校验" class="header-anchor">#</a> 4.2 ValidationProvider 数据校验</h3> <p>数据校验是可以避免写大量<code>if-else</code>逻辑进行校验判断，并且可以通过文档化入参格式限制。
<code>ValidationProvider</code>接口提供了系列抽象功能。
<code>hibernate-validator</code>依赖中对其功能做具体扩展实现，同样也是通过SPI机制实现。
后面可以专门总结一下常用的数据校验方式，以及实际基础类打点校验是如何实现和实践的。</p> <h2 id="_5-dubbo、spring、jdk三种spi机制区别"><a href="#_5-dubbo、spring、jdk三种spi机制区别" class="header-anchor">#</a> 5.Dubbo、Spring、JDK三种SPI机制区别</h2> <table><thead><tr><th></th> <th><strong>JDK SPI</strong></th> <th><strong>Dubbo SPI</strong></th> <th><strong>Spring SPI</strong></th></tr></thead> <tbody><tr><td><strong>文件加载方式</strong></td> <td>每个扩展点接口一个文件</td> <td>每个扩展点接口一个文件</td> <td>所有扩展点一个文件<code>spring.factories</code></td></tr> <tr><td>是否支持获取固定实现</td> <td>不支持，只能按照顺序加载所有实现，</td> <td>具有&quot;别名&quot;，可以通过名称获取扩展点具体实现，一般配合Dubbo SPI主机使用</td> <td>不支持，按照顺序加载。但是有Spring Boot ClassLoader会优先加载用户自定义的spring.factories文件，可以保证用户自定义factory方式在第一个。</td></tr> <tr><td>其他</td> <td>无</td> <td>支持Dubbo内部的依赖注入，通过目录来区分Dubbo 内置SPI和外部SPI，优先加载内部，保证内部的优先级最高</td> <td>无</td></tr></tbody></table> <p>全文结束。</p> <hr> <p>了解更多内容，可以关注我的微信公众号，更多首发文章。</p> <p><img src="https://ccoder-markdown-oss.oss-cn-shanghai.aliyuncs.com/md/2022-07-28-064228.bmp" alt="wechat"></p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_1-介绍" title="1.介绍">1.介绍</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2-使用介绍" title="2.使用介绍">2.使用介绍</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-1-定义一个标准接口" title="2.1 定义一个标准接口">2.1 定义一个标准接口</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-2-定义实现类" title="2.2 定义实现类">2.2 定义实现类</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-3-定义配置文件" title="2.3 定义配置文件">2.3 定义配置文件</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-4-使用方式" title="2.4 使用方式">2.4 使用方式</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_3-源码分析" title="3.源码分析">3.源码分析</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-1-类成员变量梳理" title="3.1 类成员变量梳理">3.1 类成员变量梳理</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-2-查找实现类" title="3.2 查找实现类">3.2 查找实现类</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-3-实例化接口实现类" title="3.3 实例化接口实现类">3.3 实例化接口实现类</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_4-应用场景" title="4.应用场景">4.应用场景</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_4-1-jdbc使用场景" title="4.1 JDBC使用场景">4.1 JDBC使用场景</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_4-2-validationprovider-数据校验" title="4.2 ValidationProvider 数据校验">4.2 ValidationProvider 数据校验</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_5-dubbo、spring、jdk三种spi机制区别" title="5.Dubbo、Spring、JDK三种SPI机制区别">5.Dubbo、Spring、JDK三种SPI机制区别</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/ccoderJava" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>鄂ICP备2021021487号-1</a></li></ul></div></footer></div><div class="global-ui"><!----><div class="my-popup" style="display:none;" data-v-3414bdeb><div class="my-popup-container" data-v-3414bdeb><div class="my-popup-exit" data-v-3414bdeb></div> <img src="" alt data-v-3414bdeb></div></div></div></div>
    <script src="/assets/js/app.7b778307.js" defer></script><script src="/assets/js/7.97c4f7f9.js" defer></script><script src="/assets/js/3.42bf2e6b.js" defer></script><script src="/assets/js/21.6460c15b.js" defer></script>
  </body>
</html>
